# FCM Push Notifications - ูุธุงู ุงูุฅุดุนุงุฑุงุช ููุทูุจุงุช

## ๐ ููุฎุต

ุชู ุชูููุฐ ูุธุงู ุฅุดุนุงุฑุงุช Push Notifications ุจุงุณุชุฎุฏุงู Firebase Cloud Messaging (FCM) ูุฅุฑุณุงู ุฅุดุนุงุฑุงุช ููุชุงุฌุฑ ูุงูุนููู ูู ุงูุญุงูุงุช ุงูุชุงููุฉ:

| ุงูุฅุดุนุงุฑ | ุงููุณุชูู | ูุชู ููุฑุณู |
|---------|---------|-----------|
| ๐ ุทูุจ ุฌุฏูุฏ! | ุงูุชุงุฌุฑ | ุนูุฏ ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ |
| โ ุชู ูุจูู ุงูุทูุจ | ุงูุชุงุฌุฑ | ุนูุฏ ูุจูู ููุชุจ ุงูุชูุตูู |
| โ ุชู ุฑูุถ ุงูุทูุจ | ุงูุชุงุฌุฑ | ุนูุฏ ุฑูุถ ููุชุจ ุงูุชูุตูู ููุงุฆูุงู |
| ๐ ุชู ุชุณููู ุทูุจู! | ุงูุนููู | ุนูุฏ ุชุณููู ุงูุทูุจ ุจูุฌุงุญ |

---

## ๐ ุงููููุงุช ุงููููุดุฃุฉ ูุงูููุนุฏููุฉ

### Flutter App

#### ูููุงุช ุฌุฏูุฏุฉ:
| ุงูููู | ุงููุตู |
|-------|-------|
| `lib/services/fcm_service.dart` | ุฎุฏูุฉ ุฅุฏุงุฑุฉ FCM ููุชูููุงุช ูุงูุฅุดุนุงุฑุงุช |

#### ูููุงุช ูุนุฏูุฉ:
| ุงูููู | ุงูุชุนุฏูู |
|-------|---------|
| `lib/main.dart` | ุฅุถุงูุฉ ุชููุฆุฉ FCM ุนูุฏ ุจุฏุก ุงูุชุทุจูู |
| `lib/markets/create_market/models/store_model.dart` | ุฅุถุงูุฉ ุญูู `fcmToken` |
| `lib/markets/order_of_markets/pages/MarketOrdersPage.dart` | ุญูุธ FCM token ูููุชุฌุฑ |
| `lib/authentication/viewModel/AuthViewModel.dart` | ุญูุธ FCM token ูููุณุชุฎุฏู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู |

### Cloud Functions

#### ูููุงุช ุฌุฏูุฏุฉ:
| ุงูููู | ุงููุตู |
|-------|-------|
| `functions/src/notifications/sendOrderNotification.ts` | ุฅุดุนุงุฑ ููุชุงุฌุฑ ุนูุฏ ุทูุจ ุฌุฏูุฏ |
| `functions/src/notifications/sendStatusNotification.ts` | ุฅุดุนุงุฑุงุช ุชุบููุฑ ุญุงูุฉ ุงูุทูุจ |

#### ูููุงุช ูุนุฏูุฉ:
| ุงูููู | ุงูุชุนุฏูู |
|-------|---------|
| `functions/src/index.ts` | ุชุตุฏูุฑ ุฏูุงู ุงูุฅุดุนุงุฑุงุช ุงูุฌุฏูุฏุฉ |

---

## ๐ง ููููุฉ ุงูุนูู

### 1. ุชุณุฌูู FCM Token

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ุชุณุฌูู FCM Token                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  ุงููุณุชุฎุฏู/ุงูุชุงุฌุฑ ููุชุญ ุงูุชุทุจูู                               โ
โ         โ                                                   โ
โ  FcmService().initialize() ูุทูุจ ุงูุตูุงุญูุงุช                   โ
โ         โ                                                   โ
โ  ุงูุญุตูู ุนูู FCM Token ูู Firebase                          โ
โ         โ                                                   โ
โ  โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ                โ
โ  โ ุงููุณุชุฎุฏู ูุณุฌู   โ    โ ุงูุชุงุฌุฑ ููุชุญ     โ                โ
โ  โ ุงูุฏุฎูู          โ    โ ุตูุญุฉ ุงูุทูุจุงุช    โ                โ
โ  โโโโโโโโโโฌโโโโโโโโโ    โโโโโโโโโโฌโโโโโโโโโ                โ
โ           โ                      โ                          โ
โ  saveTokenForUser()     saveTokenForStore()                 โ
โ           โ                      โ                          โ
โ  users/{userId}/fcmToken  markets/{storeId}/fcmToken        โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 2. ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  โโโโโโโโโโโโโโโโ                                          โ
โ  โ ุทูุจ ุฌุฏูุฏ     โ โ sendNewOrderNotification               โ
โ  โโโโโโโโฌโโโโโโโโ   (Trigger: onCreate present_order)      โ
โ         โ                                                   โ
โ  ุฌูุจ fcmToken ูู markets/{storeId}                         โ
โ         โ                                                   โ
โ  ุฅุฑุณุงู ุฅุดุนุงุฑ ููุชุงุฌุฑ: "๐ ุทูุจ ุฌุฏูุฏ!"                        โ
โ                                                             โ
โ  โโโโโโโโโโโโโโโโ                                          โ
โ  โ ุชุบููุฑ ุญุงูุฉ   โ โ sendOrderStatusNotification            โ
โ  โโโโโโโโฌโโโโโโโโ   (Trigger: onUpdate present_order)      โ
โ         โ                                                   โ
โ  โโ accepted โ ุฅุดุนุงุฑ ููุชุงุฌุฑ: "โ ุชู ูุจูู ุงูุทูุจ"            โ
โ  โโ rejected โ ุฅุดุนุงุฑ ููุชุงุฌุฑ: "โ ุชู ุฑูุถ ุงูุทูุจ"             โ
โ  โโ completed โ ุฅุดุนุงุฑ ููุนููู: "๐ ุชู ุชุณููู ุทูุจู!"          โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ุฎุทูุงุช ุงููุดุฑ

### 1. ูุดุฑ Cloud Functions

```bash
cd functions
npm run build
firebase deploy --only functions:sendNewOrderNotification,functions:sendOrderStatusNotification,functions:sendPastOrderNotification
```

### 2. ุจูุงุก ุงูุชุทุจูู

```bash
flutter build apk --release
# ุฃู
flutter build appbundle --release
```

---

## ๐ฑ ุชุฌุฑุจุฉ ุงูุฅุดุนุงุฑุงุช

### ุดุฑูุท ุงูุนูู:
1. **ุงูุชุงุฌุฑ**: ูุฌุจ ูุชุญ ุตูุญุฉ ุงูุทูุจุงุช ูุฑุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู ูุชุณุฌูู FCM Token
2. **ุงูุนููู**: ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู ูุชุณุฌูู FCM Token
3. **ุงูุตูุงุญูุงุช**: ูุฌุจ ูุจูู ุตูุงุญูุงุช ุงูุฅุดุนุงุฑุงุช ุนูู ุงูุฌูุงุฒ

### ุงุฎุชุจุงุฑ ูุฏูู:
1. ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ โ ุงูุชุงุฌุฑ ูุณุชูู ุฅุดุนุงุฑ
2. ูุจูู ุงูุทูุจ ูู ููุชุจ ุงูุชูุตูู โ ุงูุชุงุฌุฑ ูุณุชูู ุฅุดุนุงุฑ
3. ุฑูุถ ุงูุทูุจ ููุงุฆูุงู โ ุงูุชุงุฌุฑ ูุณุชูู ุฅุดุนุงุฑ
4. ุชุณููู ุงูุทูุจ ููุนููู โ ุงูุนููู ูุณุชูู ุฅุดุนุงุฑ

---

## ๐๏ธ ุงูุจููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุญููู ุฌุฏูุฏุฉ ูู `markets/{storeId}`:
```json
{
  "fcmToken": "dXYZ123...",
  "fcmTokenUpdatedAt": "2025-12-25T20:00:00Z"
}
```

### ุญููู ุฌุฏูุฏุฉ ูู `users/{userId}`:
```json
{
  "fcmToken": "aBC789...",
  "fcmTokenUpdatedAt": "2025-12-25T20:00:00Z"
}
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุชุญุฏูุซ ุงูุชููู ุชููุงุฆูุงู**: ูุชู ุชุญุฏูุซ FCM Token ุชููุงุฆูุงู ุนูุฏ ุชุบููุฑู (ูุซู ุฅุนุงุฏุฉ ุชุซุจูุช ุงูุชุทุจูู)

2. **ุงูุชุทุจูู ููุชูุญ vs ูุบูู**:
   - **ููุชูุญ**: ุงูุฅุดุนุงุฑ ูุธูุฑ ูู foreground message (ูููู ุนุฑุถู ูู dialog)
   - **ูุบูู/ุฎูููุฉ**: ุงูุฅุดุนุงุฑ ูุธูุฑ ูู ุดุฑูุท ุงูุฅุดุนุงุฑุงุช

3. **ุงูุฃูุงู**: FCM Tokens ุญุณุงุณุฉ ููุฌุจ ุนุฏู ูุดุงุฑูุชูุง ุนูููุงู

---

## ๐ Cloud Functions ุงููุถุงูุฉ

| Function | Trigger | ุงููุตู |
|----------|---------|-------|
| `sendNewOrderNotification` | `onCreate: present_order` | ุฅุดุนุงุฑ ููุชุงุฌุฑ ุนูุฏ ุทูุจ ุฌุฏูุฏ |
| `sendOrderStatusNotification` | `onUpdate: present_order` | ุฅุดุนุงุฑ ุนูุฏ ุชุบููุฑ ุญุงูุฉ ุงูุทูุจ |
| `sendPastOrderNotification` | `onCreate: past_order` | ุฅุดุนุงุฑ ููุนููู ุนูุฏ ููู ุงูุทูุจ ููุฃุฑุดูู |
