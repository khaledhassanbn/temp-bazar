# نظام إدارة طلبات المتاجر

## نظرة عامة
تم تطوير نظام إدارة الطلبات ليعرض الطلبات الحقيقية من Firebase بناءً على ID المتجر، مع إمكانية تغيير حالة الطلبات من خلال واجهة المستخدم.

## الميزات الجديدة

### 1. جلب البيانات الحقيقية من Firebase
- يتم جلب الطلبات من `markets/{marketId}/present_order`
- تحديث تلقائي للطلبات الجديدة باستخدام Firebase Stream
- ترتيب الطلبات حسب وقت الإنشاء (الأحدث أولاً)

### 2. عرض محسن للطلبات
- عرض تفصيلي للمنتجات مع الكميات والأسعار
- عرض الخيارات الإضافية بشكل منفصل
- إحصائيات الطلبات حسب الحالة
- بحث متقدم برقم الطلب أو اسم العميل

### 3. إدارة حالات الطلبات
- **قيد المراجعة**: يمكن استلام أو رفض الطلب
- **تم استلام الطلب**: يمكن طلب طيار أو رفض الطلب
- **جارى تسليم للدليفري**: يمكن تأكيد التسليم للطيار
- **تم التسليم للطيار**: حالة نهائية مع عرض تأكيد
- **تم رفض الطلب**: حالة نهائية مع عرض سبب الرفض

### 4. واجهة مستخدم محسنة
- إحصائيات مرئية للطلبات
- رسائل خطأ واضحة
- تحميل سلس مع مؤشرات التقدم
- رسوم متحركة للعناصر

## كيفية الاستخدام

### 1. فتح صفحة الطلبات
```dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => MarketOrdersPage(marketId: 'your_market_id'),
  ),
);
```

### 2. البحث في الطلبات
- يمكن البحث برقم الطلب (مثل: `MARKET_2501011200_ABC123`)
- يمكن البحث باسم العميل
- البحث يعمل في الوقت الفعلي

### 3. تغيير حالة الطلب
- اضغط على الزر المناسب للحالة الحالية
- أكد العملية في النافذة المنبثقة
- سيتم تحديث الحالة في Firebase تلقائياً

## هيكل البيانات في Firebase

### مسار الطلبات
```
markets/{marketId}/present_order/{orderId}
```

### هيكل بيانات الطلب
```json
{
  "orderId": "MARKET_2501011200_ABC123",
  "createdAt": "timestamp",
  "status": "pending|accepted|preparing|delivered|rejected",
  "customerInfo": {
    "name": "اسم العميل",
    "phone": "رقم الهاتف",
    "address": "العنوان",
    "location": "الإحداثيات"
  },
  "items": [
    {
      "productId": "product_id",
      "productName": "اسم المنتج",
      "quantity": 2,
      "unitPrice": 50.0,
      "totalPrice": 100.0,
      "selectedOptions": ["خيار1", "خيار2"]
    }
  ],
  "subtotal": 100.0,
  "deliveryFee": 10.0,
  "serviceFee": 5.0,
  "totalAmount": 115.0
}
```

## حالات الطلبات

| الحالة بالعربية | الحالة بالإنجليزية | الوصف |
|----------------|-------------------|--------|
| قيد المراجعة | pending | طلب جديد يحتاج مراجعة |
| تم استلام الطلب | accepted | تم قبول الطلب من المتجر |
| جارى تسليم للدليفري | preparing | الطلب جاهز للتسليم |
| تم التسليم للطيار | delivered | تم تسليم الطلب للطيار |
| تم رفض الطلب | rejected | تم رفض الطلب |

## الملفات المحدثة

1. **MarketOrdersPage.dart**: الصفحة الرئيسية مع Firebase Stream
2. **OrderCard.dart**: كارت الطلب مع عرض محسن للمنتجات
3. **OrderActionButtons.dart**: أزرار الإجراءات مع حالات محسنة

## المتطلبات
- Firebase Firestore
- flutter_animate للرسوم المتحركة
- cloud_firestore للتعامل مع قاعدة البيانات

## ملاحظات مهمة
- تأكد من إعداد Firebase بشكل صحيح
- يجب أن يكون المتجر لديه صلاحيات القراءة والكتابة في قاعدة البيانات
- النظام يعمل في الوقت الفعلي مع Firebase Stream

